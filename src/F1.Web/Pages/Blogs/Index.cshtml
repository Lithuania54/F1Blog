@page
@model F1.Web.Pages.Blogs.IndexModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["Title"] = "Blogs";
}

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Blogs</h1>
    @if (User?.Identity?.IsAuthenticated == true)
    {
        <a asp-page="/Blogs/Create" class="btn btn-primary">Write Blog</a>
    }
  </div>

  @if (Model.Posts == null || !Model.Posts.Any())
  {
    <div class="card bg-transparent border-1 border-secondary p-4 text-center">
      @if (User?.Identity?.IsAuthenticated == true)
      {
        <a asp-page="/Blogs/Create" class="btn btn-outline-light">Create first blog</a>
      }
      else
      {
        <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-outline-light">Login to write</a>
      }
    </div>
  }
  else
  {
    <div class="row gy-4">
      @foreach (var post in Model.Posts)
      {
        <div class="col-12">
          <article class="card bg-transparent border border-secondary rounded">
            <div class="row g-0 align-items-center">

              @* Branch when there is an image: split into two columns *@
              @if (!string.IsNullOrEmpty(post.ImageUrl))
              {
                  <div class="col-md-4">
                    <img src="@post.ImageUrl" alt="@post.Title" class="img-fluid rounded" style="width:100%;height:200px;object-fit:cover" />
                  </div>

                  <div class="col-md-8">
                    <div class="card-body">
                      <h2 class="h4 mb-1">
                        <a asp-page="/Blogs/Details" asp-route-id="@post.Id" class="text-decoration-none text-white">@post.Title</a>
                      </h2>

                      <div class="mb-2 text-muted small">
                        <span class="me-1">Posted:</span> @post.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                        @if (!string.IsNullOrEmpty(post.AuthorName))
                        {
                            <span> • @post.AuthorName</span>
                        }
                      </div>

                      @if (!string.IsNullOrWhiteSpace(post.Hashtags))
                      {
                          var tags = post.Hashtags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                          <div class="mb-2">
                            @foreach (var t in tags)
                            {
                                <span class="badge bg-secondary me-1">#@t</span>
                            }
                          </div>
                      }

                      @{
                          var excerpt = string.IsNullOrEmpty(post.Content) 
                              ? string.Empty 
                              : (post.Content.Length > 300 ? post.Content.Substring(0, 300) + "…" : post.Content);
                      }
                      <p class="mb-2 text-muted">@excerpt</p>

                      <a asp-page="/Blogs/Details" asp-route-id="@post.Id" class="btn btn-sm btn-outline-light me-2">Read more</a>

                      @{
                        var hasNoOwner = string.IsNullOrWhiteSpace(post.CreatedByUserName);
                        var isOwner = User?.Identity?.IsAuthenticated == true && string.Equals(User.Identity?.Name, post.CreatedByUserName, StringComparison.Ordinal);
                      }
                      @if (User?.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || hasNoOwner || isOwner))
                      {
                          <a asp-page="/Blogs/Edit" asp-route-id="@post.Id" class="btn btn-sm btn-secondary me-1">Edit</a>
                          <a asp-page="/Blogs/Delete" asp-route-id="@post.Id" class="btn btn-sm btn-danger">Delete</a>
                      }
                    </div>
                  </div>
              }
              else
              {
                  @* No image: single full-width column with card body *@
                  <div class="col-12">
                    <div class="card-body">
                      <h2 class="h4 mb-1">
                        <a asp-page="/Blogs/Details" asp-route-id="@post.Id" class="text-decoration-none text-white">@post.Title</a>
                      </h2>

                      <div class="mb-2 text-muted small">
                        <span class="me-1">Posted:</span> @post.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                        @if (!string.IsNullOrEmpty(post.AuthorName))
                        {
                            <span> • @post.AuthorName</span>
                        }
                      </div>

                      @if (!string.IsNullOrWhiteSpace(post.Hashtags))
                      {
                          var tags = post.Hashtags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                          <div class="mb-2">
                            @foreach (var t in tags)
                            {
                                <span class="badge bg-secondary me-1">#@t</span>
                            }
                          </div>
                      }

                      @{
                          var excerpt = string.IsNullOrEmpty(post.Content) 
                              ? string.Empty 
                              : (post.Content.Length > 300 ? post.Content.Substring(0, 300) + "…" : post.Content);
                      }
                      <p class="mb-2 text-muted">@excerpt</p>

                      <a asp-page="/Blogs/Details" asp-route-id="@post.Id" class="btn btn-sm btn-outline-light me-2">Read more</a>

                      @{
                        var hasNoOwner = string.IsNullOrWhiteSpace(post.CreatedByUserName);
                        var isOwner = User?.Identity?.IsAuthenticated == true && string.Equals(User.Identity?.Name, post.CreatedByUserName, StringComparison.Ordinal);
                      }
                      @if (User?.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || hasNoOwner || isOwner))
                      {
                          <a asp-page="/Blogs/Edit" asp-route-id="@post.Id" class="btn btn-sm btn-secondary me-1">Edit</a>
                          <a asp-page="/Blogs/Delete" asp-route-id="@post.Id" class="btn btn-sm btn-danger">Delete</a>
                      }
                    </div>
                  </div> 
              }

            </div>
          </article>
        </div>
      }
    </div>
  }
</div>
