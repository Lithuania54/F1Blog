@page
@model F1.Web.Pages.Blogs.IndexModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["Title"] = "Blogs";
}

<section class="g-container g-section blog-list">
  <div class="blog-list__header">
    <div>
      <div class="g-hero__eyebrow">Editorial</div>
      <h1 class="blog-list__title">Garage stories</h1>
      <p class="g-hero__text mb-0">Deep dives, weekend debriefs, and fan perspectives tailored for every Grand Prix.</p>
    </div>
    <div class="blog-list__actions">
      @if (User?.Identity?.IsAuthenticated == true)
      {
          <a asp-page="/Blogs/Create" class="g-btn g-btn-accent">Write a blog</a>
      }
      else
      {
          <a asp-page="/Auth/Login" class="g-btn g-btn-ghost">Log in to write</a>
      }
    </div>
  </div>

  @if (Model.Posts == null || !Model.Posts.Any())
  {
    <div class="g-card text-center">
      <div class="g-card__title">No posts yet</div>
      <p class="g-card__muted mb-3">Be the first to share a race breakdown or opinion piece.</p>
      @if (User?.Identity?.IsAuthenticated == true)
      {
        <a asp-page="/Blogs/Create" class="g-btn g-btn-accent">Create first blog</a>
      }
      else
      {
        <a asp-page="/Auth/Login" class="g-btn g-btn-ghost">Log in to write</a>
      }
    </div>
  }
  else
  {
    <div class="blog-grid">
      @foreach (var post in Model.Posts)
      {
        var hasImage = !string.IsNullOrEmpty(post.ImageUrl);
        var excerpt = string.IsNullOrEmpty(post.Content)
          ? string.Empty
          : (post.Content.Length > 300 ? post.Content[..300] + "..." : post.Content);
        var hasNoOwner = string.IsNullOrWhiteSpace(post.CreatedByUserName);
        var isOwner = User?.Identity?.IsAuthenticated == true && string.Equals(User.Identity?.Name, post.CreatedByUserName, StringComparison.Ordinal);

        <article class="g-card blog-card @(hasImage ? "has-image" : "")">
          @if (hasImage)
          {
            <div class="blog-card__image">
              <img src="@post.ImageUrl" alt="@post.Title" loading="lazy" />
            </div>
          }

          <div class="blog-card__body">
            <h2 class="blog-card__title">
              <a asp-page="/Blogs/Details" asp-route-id="@post.Id" class="blog-title-link">@post.Title</a>
            </h2>

            <div class="blog-card__meta">
              <span>Posted: @post.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</span>
              @if (!string.IsNullOrEmpty(post.AuthorName))
              {
                <span class="blog-card__separator">-</span>
                <span>@post.AuthorName</span>
              }
            </div>

            @if (!string.IsNullOrWhiteSpace(post.Hashtags))
            {
              var tags = post.Hashtags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
              <div class="blog-card__tags">
                @foreach (var t in tags)
                {
                  <span class="badge bg-secondary me-1">#@t</span>
                }
              </div>
            }

            <p class="blog-card__excerpt">@excerpt</p>

            <div class="blog-card__actions">
              <a asp-page="/Blogs/Details" asp-route-id="@post.Id" class="g-btn g-btn-ghost g-btn-sm">Read more</a>
              @if (User?.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || hasNoOwner || isOwner))
              {
                <a asp-page="/Blogs/Edit" asp-route-id="@post.Id" class="g-btn g-btn-sm g-btn-secondary">Edit</a>
                <a asp-page="/Blogs/Delete" asp-route-id="@post.Id" class="g-btn g-btn-sm g-btn-danger">Delete</a>
              }
            </div>
          </div>
        </article>
      }
    </div>
  }
</section>
