@page "/Game"
@model F1.Web.Pages.Game.IndexModel
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["Title"] = "Game";
}

<section class="g-section game-lede">
  <div class="g-container game-lede__inner">
    <div class="game-lede__text">
      <p class="game-kicker">Arcade</p>
      <h1 class="game-title">Race the F1 Garage build</h1>
      <p class="game-subtitle">
        Drive the bundled Godot WebGL build right in your browser—no installs needed.
      </p>
      <div class="game-controls">
        <div class="game-controls__item"><span>W / ↑</span><span>Throttle</span></div>
        <div class="game-controls__item"><span>S / ↓</span><span>Brake / Reverse</span></div>
        <div class="game-controls__item"><span>A / ←</span><span>Steer left</span></div>
        <div class="game-controls__item"><span>D / →</span><span>Steer right</span></div>
        <div class="game-controls__item"><span>Space</span><span>Handbrake</span></div>
        <div class="game-controls__item"><span>R</span><span>Reset car</span></div>
        <div class="game-controls__item"><span>F</span><span>Fullscreen</span></div>
      </div>
    </div>
  </div>
</section>

<section class="g-section">
  <div class="g-container">
    <div class="f1-game" aria-label="F1 WebGL game">
      <canvas id="canvas">
        HTML5 canvas appears to be unsupported in the current browser.<br />
        Please try updating or use a different browser.
      </canvas>
      <div id="status">
        <div id="status-progress" oncontextmenu="event.preventDefault();"><div id="status-progress-inner"></div></div>
        <div id="status-indeterminate" oncontextmenu="event.preventDefault();">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
        <div id="status-notice" class="godot"></div>
      </div>
    </div>
  </div>
</section>

@section Styles {
  <style>
    .game-lede {
      padding-bottom: 0;
    }

    .game-lede__inner {
      display: grid;
      grid-template-columns: 1fr;
    }

    .game-lede__text {
      display: grid;
      gap: 10px;
      max-width: 880px;
    }

    .game-kicker {
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      margin: 0;
    }

    .game-title {
      font-size: clamp(2rem, 3vw, 2.9rem);
      letter-spacing: -0.02em;
      margin: 0;
    }

    .game-subtitle {
      margin: 0;
      color: var(--muted);
      max-width: 820px;
    }

    .game-subtitle code {
      background: rgba(0, 0, 0, 0.05);
      padding: 2px 8px;
      border-radius: 8px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .game-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .game-controls__item {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      font-weight: 600;
      color: var(--ink);
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.04);
    }

    .game-controls__item span:first-child {
      color: var(--muted);
    }

    .f1-game {
      position: relative;
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid #0d0d0f;
      box-shadow: 0 28px 50px rgba(0, 0, 0, 0.25);
      isolation: isolate;
    }

    .f1-game #canvas {
      display: block;
      margin: 0;
      width: 100%;
      height: min(900px, 78vh);
      background-color: #000;
      color: #fff;
      touch-action: none;
    }

    .f1-game #canvas:focus {
      outline: none;
    }

    .f1-game #status {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      pointer-events: none;
    }

    .f1-game #status-progress {
      width: 366px;
      height: 7px;
      background-color: #38363a;
      border: 1px solid #444246;
      padding: 1px;
      box-shadow: 0 0 2px 1px #1b1c22;
      border-radius: 2px;
      visibility: visible;
      display: none;
    }

    @@media only screen and (orientation: portrait) {
      .f1-game #status-progress {
        width: 61.8%;
      }
    }

    .f1-game #status-progress-inner {
      height: 100%;
      width: 0;
      box-sizing: border-box;
      transition: width 0.5s linear;
      background-color: #202020;
      border: 1px solid #222223;
      box-shadow: 0 0 1px 1px #27282e;
      border-radius: 3px;
    }

    .f1-game #status-indeterminate {
      height: 42px;
      visibility: visible;
      position: relative;
      display: none;
    }

    .f1-game #status-indeterminate > div {
      width: 4.5px;
      height: 0;
      border-style: solid;
      border-width: 9px 3px 0 3px;
      border-color: #2b2b2b transparent transparent transparent;
      transform-origin: center 21px;
      position: absolute;
    }

    .f1-game #status-indeterminate > div:nth-child(1) { transform: rotate(22.5deg); }
    .f1-game #status-indeterminate > div:nth-child(2) { transform: rotate(67.5deg); }
    .f1-game #status-indeterminate > div:nth-child(3) { transform: rotate(112.5deg); }
    .f1-game #status-indeterminate > div:nth-child(4) { transform: rotate(157.5deg); }
    .f1-game #status-indeterminate > div:nth-child(5) { transform: rotate(202.5deg); }
    .f1-game #status-indeterminate > div:nth-child(6) { transform: rotate(247.5deg); }
    .f1-game #status-indeterminate > div:nth-child(7) { transform: rotate(292.5deg); }
    .f1-game #status-indeterminate > div:nth-child(8) { transform: rotate(337.5deg); }

    .f1-game #status-notice {
      margin: 0 100px;
      line-height: 1.3;
      visibility: visible;
      padding: 4px 6px;
      display: none;
    }

    .f1-game .godot {
      font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
      color: #e0e0e0;
      background-color: #3b3943;
      background-image: linear-gradient(to bottom, #403e48, #35333c);
      border: 1px solid #45434e;
      box-shadow: 0 0 1px 1px #2f2d35;
    }

    @@media (max-width: 720px) {
      .f1-game #canvas {
        height: 70vh;
      }
    }
  </style>
}

@section Scripts {
  <script>
    // Force a safe storage shim so Godot's get_unique_id() never fails, even when the browser blocks storage.
    (function () {
      function makeMemoryStorage() {
        const store = {};
        return {
          getItem: (k) => (k in store ? store[k] : null),
          setItem: (k, v) => { store[k] = String(v); },
          removeItem: (k) => { delete store[k]; },
          clear: () => { Object.keys(store).forEach((k) => delete store[k]); },
          key: (i) => Object.keys(store)[i] ?? null,
          get length() { return Object.keys(store).length; }
        };
      }
      function forceStorage(name) {
        let storage;
        try {
          const testKey = '__godot_storage_test__';
          storage = window[name];
          storage.setItem(testKey, '1');
          storage.removeItem(testKey);
        } catch (_) {
          storage = makeMemoryStorage();
          Object.defineProperty(window, name, {
            value: storage,
            configurable: true
          });
          console.warn(`Tracking prevention blocked ${name}; using in-memory fallback.`);
        }
        return storage;
      }
      const ls = forceStorage('localStorage');
      forceStorage('sessionStorage');
      try {
        if (!ls.getItem('GodotUserId')) {
          const guid = (globalThis.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
          ls.setItem('GodotUserId', guid);
        }
      } catch (_) { /* ignore */ }
    })();
  </script>
  <script src="~/game/index.js"></script>
  <script>
    const GODOT_CONFIG = {
      args: [],
      canvasResizePolicy: 2,
      executable: "/game/index",
      mainPack: "/game/index.pck",
      experimentalVK: false,
      fileSizes: {
        "/game/index.pck": 10133024,
        "/game/index.wasm": 13790961
      },
      focusCanvas: true,
      gdnativeLibs: []
    };
    var engine = new Engine(GODOT_CONFIG);

    (function () {
      const INDETERMINATE_STATUS_STEP_MS = 100;
      var statusProgress = document.getElementById('status-progress');
      var statusProgressInner = document.getElementById('status-progress-inner');
      var statusIndeterminate = document.getElementById('status-indeterminate');
      var statusNotice = document.getElementById('status-notice');
      var statusWrapper = document.getElementById('status');

      var initializing = true;
      var statusMode = 'hidden';

      var animationCallbacks = [];
      function animate(time) {
        animationCallbacks.forEach(callback => callback(time));
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);

      function setStatusMode(mode) {

        if (statusMode === mode || !initializing)
          return;
        [statusProgress, statusIndeterminate, statusNotice].forEach(elem => {
          elem.style.display = 'none';
        });
        animationCallbacks = animationCallbacks.filter(function (value) {
          return (value != animateStatusIndeterminate);
        });
        switch (mode) {
          case 'progress':
            statusProgress.style.display = 'block';
            statusWrapper.style.visibility = 'visible';
            break;
          case 'indeterminate':
            statusIndeterminate.style.display = 'block';
            animationCallbacks.push(animateStatusIndeterminate);
            statusWrapper.style.visibility = 'visible';
            break;
          case 'notice':
            statusNotice.style.display = 'block';
            statusWrapper.style.visibility = 'visible';
            break;
          case 'hidden':
            statusWrapper.style.visibility = 'hidden';
            break;
          default:
            throw new Error('Invalid status mode');
        }
        statusMode = mode;
      }

      function animateStatusIndeterminate(ms) {
        var i = Math.floor(ms / INDETERMINATE_STATUS_STEP_MS % 8);
        if (statusIndeterminate.children[i].style.borderTopColor == '') {
          Array.prototype.slice.call(statusIndeterminate.children).forEach(child => {
            child.style.borderTopColor = '';
          });
          statusIndeterminate.children[i].style.borderTopColor = '#dfdfdf';
        }
      }

      function setStatusNotice(text) {
        while (statusNotice.lastChild) {
          statusNotice.removeChild(statusNotice.lastChild);
        }
        var lines = text.split('\n');
        lines.forEach((line) => {
          statusNotice.appendChild(document.createTextNode(line));
          statusNotice.appendChild(document.createElement('br'));
        });
      };

      function displayFailureNotice(err) {
        var msg = err.message || err;
        console.error(msg);
        setStatusNotice(msg);
        setStatusMode('notice');
        initializing = false;
      };

      if (!Engine.isWebGLAvailable()) {
        displayFailureNotice('WebGL not available');
      } else {
        setStatusMode('indeterminate');
        engine.startGame({
          'onProgress': function (current, total) {
            if (total > 0) {
              statusProgressInner.style.width = current / total * 100 + '%';
              setStatusMode('progress');
              if (current === total) {
                // wait for progress bar animation
                setTimeout(() => {
                  setStatusMode('indeterminate');
                }, 500);
              }
            } else {
              setStatusMode('indeterminate');
            }
          },
        }).then(() => {
          setStatusMode('hidden');
          initializing = false;
        }, displayFailureNotice);
      }
    })();
  </script>
}
